{"ignition":{"config":{},"timeouts":{},"version":"2.1.0"},"networkd":{},"passwd":{},"storage":{"files":[{"filesystem":"root","group":{},"path":"/root/etcd_bootstrap.sh","user":{},"contents":{"source":"data:,ec2_instance_id%3D%24(%2Fusr%2Fbin%2Fcurl%20-s%20http%3A%2F%2F169.254.169.254%2Flatest%2Fmeta-data%2Finstance-id)%0A%0Aec2_instance_ip%3D%24(%2Fusr%2Fbin%2Fcurl%20-s%20http%3A%2F%2F169.254.169.254%2Flatest%2Fmeta-data%2Flocal-ipv4)%0A%0Aec2_instance_region%3D%24(%2Fusr%2Fbin%2Fcurl%20-s%20http%3A%2F%2F169.254.169.254%2Flatest%2Fdynamic%2Finstance-identity%2Fdocument%20%7C%20%2Fusr%2Fbin%2Fgrep%20region%20%7C%20%2Fusr%2Fbin%2Fawk%20-F%5C%22%20'%7Bprint%20%244%7D')%0A%0A%2Fusr%2Fbin%2Fecho%20ETCD_NAME%3D%24ec2_instance_id%20%3E%20%2Froot%2Fcluster_data.txt%0A%0A%2Fusr%2Fbin%2Fecho%20EC2_IP%3D%24ec2_instance_ip%20%3E%3E%20%2Froot%2Fcluster_data.txt%0A%0Aasg_name%3D%24(docker%20run%20-e%20%22AWS_DEFAULT_REGION%3D%24ec2_instance_region%22%20cgswong%2Faws%3Alatest%20aws%20autoscaling%20describe-auto-scaling-instances%20--instance-ids%3D%24ec2_instance_id%20%7C%20jq%20-r%20.%5B%5D%5B0%5D.AutoScalingGroupName)%0A%0A%2Fusr%2Fbin%2Fecho%20EC2_ASG_NAME%3D%24asg_name%20%3E%3E%20%2Froot%2Fcluster_data.txt%0A%0Aetcd_peer_urls%3D%24(docker%20run%20-e%20%22AWS_DEFAULT_REGION%3D%24ec2_instance_region%22%20cgswong%2Faws%3Alatest%20aws%20ec2%20describe-instances%20--instance-ids%20%24(docker%20run%20-e%20%22AWS_DEFAULT_REGION%3D%24ec2_instance_region%22%20cgswong%2Faws%3Alatest%20aws%20autoscaling%20describe-auto-scaling-groups%20--auto-scaling-group-name%20%24asg_name%20%7C%20jq%20.AutoScalingGroups%5B0%5D.Instances%5B%5D.InstanceId%20%7C%20xargs)%20%7C%20jq%20-r%20'.Reservations%5B%5D.Instances%20%7C%20map(.InstanceId%20%2B%20%22%3Dhttp%3A%2F%2F%22%20%2B%20.NetworkInterfaces%5B%5D.PrivateIpAddress%20%2B%20%22%3A2380%22)%5B%5D'%20%7C%20xargs%20%7C%20sed%20's%2F%20%20*%2F%2C%2Fg')%0A%0A%2Fusr%2Fbin%2Fecho%20ETCD_INITIAL_CLUSTER%3D%24etcd_peer_urls%20%3E%3E%20%2Froot%2Fcluster_data.txt%0A%0A%2Fusr%2Fbin%2Fecho%20ETCD_INITIAL_CLUSTER_STATE%3Dexisting%20%3E%3E%20%2Froot%2Fcluster_data.txt%0A","verification":{}},"mode":493},{"filesystem":"root","group":{},"path":"/root/networkcheck.sh","user":{},"contents":{"source":"data:,SERVER%3D%22google.com%22%0Aretcode%3D1%0Awhile%20%5B%20%24retcode%20!%3D%200%20%5D%3B%20do%0A%20%20ping%20-c%201%20%24SERVER%20%3E%2Fdev%2Fnull%202%3E%261%0A%20%20retcode%3D%24%3F%0Adone%0Aexit%200%0A","verification":{}},"mode":493},{"filesystem":"root","group":{},"path":"/etc/coreos/update.conf","user":{},"contents":{"source":"data:,%0AREBOOT_STRATEGY%3D%22etcd-lock%22","verification":{}},"mode":420}]},"systemd":{"units":[{"dropins":[{"contents":"[Unit]\nRequires=coreos-metadata.service\nAfter=coreos-metadata.service\n\n[Service]\nEnvironmentFile=/run/metadata/coreos\nEnvironment=\"ETCD_IMAGE_TAG=v3.2.11\"\nExecStart=\nExecStart=/usr/lib/coreos/etcd-wrapper $ETCD_OPTS \\\n  --listen-peer-urls=\"http://${COREOS_EC2_IPV4_LOCAL}:2380\" \\\n  --listen-client-urls=\"http://0.0.0.0:2379\" \\\n  --initial-advertise-peer-urls=\"http://${COREOS_EC2_IPV4_LOCAL}:2380\" \\\n  --advertise-client-urls=\"http://${COREOS_EC2_IPV4_LOCAL}:2379\"","name":"20-clct-etcd-member.conf"}],"enable":true,"name":"etcd-member.service"},{"dropins":[{"contents":"[Unit]\nRequires=coreos-metadata.service\nAfter=coreos-metadata.service\n[Service]\nEnvironmentFile=/root/cluster_data.txt\n","name":"etcd_envvars.conf"}],"name":"etcd-member.service"},{"contents":"[Unit]\nDescription=\"Run script to gather facts for etcd cluster bootstrapping\"\nRequires=network-online.target\nAfter=network.target network-online.target networkcheck.service\nBefore=etcd-member.service\n\n[Service]\nType=oneshot\nExecStart=/bin/sh /root/etcd_bootstrap.sh\n\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"etcd_bootstrap.service"},{"contents":"[Unit]\nRequires=network-online.target\nAfter=network.target network-online.target\nBefore=etcd_bootstrap.service\n\n[Service]\nType=oneshot\nExecStart=/bin/sh /root/networkcheck.sh\n\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"networkcheck.service"},{"enabled":false,"name":"etcd2.service"}]}}